import tweepy
import json
from kafka import KafkaProducer
import nltk.corpus
goodword = open('DadosTrumpAbort31/goodword.txt')
goodtwoword = open('DadosTrumpAbort31/goodtwoword.txt')
goodthreeword = open('DadosTrumpAbort31/goodthreeword.txt')
badword = open('DadosTrumpAbort31/badword.txt')
badtwoword = open('DadosTrumpAbort31/badtwoword.txt')
badthreeword = open('DadosTrumpAbort31/badthreeword.txt')
goodwordA=dict()
goodtwowordA=dict()
goodthreewordA=dict()
badwordA=dict()
badtwowordA=dict()
badthreewordA=dict()

def ajuda(ficheiro,ficheiro2):
    helppos=dict()
    helpneg= dict()
    count=0.0
    for line in ficheiro:
        for w in nltk.word_tokenize(line):
            if w.isdigit():
                helppos[aux]=float(w)
                count = count+float(w)
            else:
                helppos[w]=0
                aux=w
    for line in ficheiro2:
        for w in nltk.word_tokenize(line):
            if w.isdigit():
                helpneg[aux]=float(w)
                count = count+float(w)
            else:
                helpneg[w]=0
                aux=w
    
    for i in helppos:
        helppos[i]=float(helppos[i]/count)
    for i in helpneg:
        helpneg[i]=float(helpneg[i]/count)
    ficheiro.close()
    ficheiro2.close()
    return (helppos,helpneg)



class TwitterListener(tweepy.StreamListener):
    def __init__(self):
        self.stop=set(nltk.corpus.stopwords.words('english'))
        self.stop.update(['http','https','rt'])
        self.producer = KafkaProducer(bootstrap_servers='localhost:9092')
        self.topicbad = 'badtopic'
        self.topicgood = 'goodtopic'
        (self.goodword, self.badword)=ajuda(goodword,badword)
        #self.goodtwoword=ajuda(goodtwoword)
        #self.goodthreeword=ajuda(goodthreeword)

        #self.badword=ajuda(badword)
        #self.badtwoword=ajuda(badtwoword)
        #self.badthreeword=ajuda(badthreeword)

    def on_data(self, data):
        contagempos= 0.0
        contagemneg= 0.0
        tweet = json.loads(data)
        texto = ''
        if 'text' in tweet:
            tokens = nltk.word_tokenize(tweet['text'])
            for w in tokens:
                w = w.lower()
                w = w.encode('utf-8')
                if w.isalpha() and w not in self.stop:
                    if str(w) in self.goodword.keys():
                        contagempos= contagempos + self.goodword[w]
                    if str(w) in self.badword.keys():
                        contagemneg= contagemneg + self.badword[w]
                    texto=texto + ' ' + w
            texto = texto.encode('utf-8')
            print(texto + '\n') 
            if contagempos>contagemneg:
                print(' pos\n')
                self.producer.send(self.topicgood,texto)
            elif contagemneg>contagempos:
                print('neg\n')
                self.producer.send(self.topicbad,texto)
            else:
                print('pos: ' + str(contagempos) + 'neg: ' + str(contagemneg))
                self.producer.send('pubmaintopic',texto)
        return True

consumer_key = "eaFmBSxUveRJfmyZYeabti9Q9"
consumer_secret= "ADf76fi3O1lKMzBxWnjqf93l3GHv28uar3bkblkvyBrAyoA23i"
acess_token= "702208758362087425-HZiyl1x7Bh98cQa1WLBDYylyu10Bpl7"
acess_token_secret= "IiNOTfgE3tEZvW2HDQhRKPMoOLU43NXJCXk8maj51SdAT"
auth = tweepy.OAuthHandler(consumer_key, consumer_secret)
auth.set_access_token(acess_token,acess_token_secret)
stream = tweepy.Stream(auth, TwitterListener())
stream.filter(track=['donaldtrump'])


